substitutions:
  device_name: doorbell-basement-door
  friendly_name: "Doorbell Basement Door"
    # API encryption key for Home Assistant
  # Generate with: esphome fingerprint-doorbell.yaml run
  api_encryption_key: "secret"

  # OTA password for over-the-air updates
  ota_password: "also-secret"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  libraries:
    - "adafruit/Adafruit Fingerprint Sensor Library@^2.1.0"

# Load external component
external_components:
  - source:
      type: local
      path: /config/components
    components: [ fingerprint_sensor ]

esp32:
  board: wemos_d1_mini32
  framework:
    type: arduino


wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${friendly_name} - Wlan"
    password: "12345678"

captive_portal:

# Enable logging
logger:
  level: INFO

ota:
  - platform: esphome
    password: ${ota_password}

web_server:
  port: 80

# Time component for timestamps
time:
  - platform: homeassistant
    id: homeassistant_time

# UART for fingerprint sensor
uart:
  id: fingerprint_uart
  tx_pin: GPIO17
  rx_pin: GPIO16
  baud_rate: 57600

# Binary sensor for touch ring
binary_sensor:
  - platform: gpio
    pin: 
      number: GPIO5
      mode: INPUT_PULLDOWN
    id: touch_ring
    internal: true
    filters:
      - delayed_on: 10ms
    on_press:
      - logger.log: "Touch ring detected"

  # Doorbell ring event (exposed to Home Assistant)
  - platform: template
    name: "${friendly_name} Ring"
    id: doorbell_ring
    device_class: occupancy
    icon: "mdi:doorbell"

# Fingerprint sensor component
fingerprint_sensor:
  id: fingerprint_component
  uart_id: fingerprint_uart
  match_id:
    name: "${friendly_name} Last Match ID"
    id: last_match_id
  match_name:
    name: "${friendly_name} Last Match Name"
    id: last_match_name
  confidence:
    name: "${friendly_name} Match Confidence"
    id: match_confidence
  enrolled_count:
    name: "${friendly_name} Enrolled Count"
    id: enrolled_count
  status:
    name: "${friendly_name} Status"
    id: sensor_status
  ring:
    name: "${friendly_name} Fingerprint Ring"
    id: fingerprint_ring
    internal: true

# Additional info sensors
text_sensor:
  - platform: version
    name: "${friendly_name} ESPHome Version"

  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"

# Switches
switch:
  - platform: template
    name: "${friendly_name} Ignore Touch Ring"
    id: ignore_touch_ring
    icon: "mdi:gesture-tap"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - logger.log: "Touch ring disabled (rain mode)"
    turn_off_action:
      - logger.log: "Touch ring enabled"

# Output for doorbell trigger
output:
  - platform: gpio
    pin: GPIO19
    id: doorbell_output

# Services for Home Assistant
# These allow you to call actions from Home Assistant
api:
  encryption:
    key: ${api_encryption_key}
  services:
    # Enroll a new fingerprint
    - service: enroll_fingerprint
      variables:
        finger_id: int
        finger_name: string
      then:
        - logger.log:
            format: "Starting enrollment for ID %d with name %s"
            args: [ 'finger_id', 'finger_name.c_str()' ]
        - lambda: |-
            id(fingerprint_component).enroll_fingerprint(finger_id, finger_name);
            
    # Delete a fingerprint
    - service: delete_fingerprint
      variables:
        finger_id: int
      then:
        - logger.log:
            format: "Deleting fingerprint ID %d"
            args: [ 'finger_id' ]
        - lambda: |-
            id(fingerprint_component).delete_fingerprint(finger_id);
            
    # Clear all fingerprints
    - service: clear_all_fingerprints
      then:
        - logger.log: "Clearing all fingerprints from sensor"
        - lambda: |-
            id(fingerprint_component).clear_all();

# Button entities for quick actions
button:
  - platform: restart
    name: "${friendly_name} Restart"
