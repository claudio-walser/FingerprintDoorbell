substitutions:
  device_name: doorbell-basement-door
  friendly_name: "Doorbell Basement Door"
  
esphome:
  name: ${device_name}
  platform: ESP32
  board: esp32doit-devkit-v1
  includes:
    - fingerprint_sensor.h
  libraries:
    - "adafruit/Adafruit Fingerprint Sensor Library@^2.1.0"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${friendly_name} - Wlan"
    password: "12345678"

captive_portal:

# Enable logging
logger:
  level: INFO

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  password: !secret ota_password

web_server:
  port: 80

# Time component for timestamps
time:
  - platform: homeassistant
    id: homeassistant_time

# UART for fingerprint sensor
uart:
  id: fingerprint_uart
  tx_pin: GPIO17
  rx_pin: GPIO16
  baud_rate: 57600

# Binary sensor for touch ring
binary_sensor:
  - platform: gpio
    pin: 
      number: GPIO5
      mode: INPUT_PULLDOWN
    id: touch_ring
    internal: true
    filters:
      - delayed_on: 10ms
    on_press:
      - logger.log: "Touch ring detected"

  # Doorbell ring event (exposed to Home Assistant)
  - platform: template
    name: "${friendly_name} Ring"
    id: doorbell_ring
    device_class: occupancy
    icon: "mdi:doorbell"
    
# Sensors exposed to Home Assistant
sensor:
  - platform: template
    name: "${friendly_name} Last Match ID"
    id: last_match_id
    icon: "mdi:fingerprint"
    accuracy_decimals: 0
    
  - platform: template
    name: "${friendly_name} Match Confidence"
    id: match_confidence
    icon: "mdi:percent"
    unit_of_measurement: "%"
    accuracy_decimals: 0
    
  - platform: template
    name: "${friendly_name} Enrolled Count"
    id: enrolled_count
    icon: "mdi:counter"
    accuracy_decimals: 0

# Text sensors for names and status
text_sensor:
  - platform: template
    name: "${friendly_name} Last Match Name"
    id: last_match_name
    icon: "mdi:account"
    
  - platform: template
    name: "${friendly_name} Status"
    id: sensor_status
    icon: "mdi:information"

  - platform: version
    name: "${friendly_name} ESPHome Version"

  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"

# Switches
switch:
  - platform: template
    name: "${friendly_name} Ignore Touch Ring"
    id: ignore_touch_ring
    icon: "mdi:gesture-tap"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - logger.log: "Touch ring disabled (rain mode)"
    turn_off_action:
      - logger.log: "Touch ring enabled"

# Output for doorbell trigger
output:
  - platform: gpio
    pin: GPIO19
    id: doorbell_output

# Custom component for fingerprint sensor
custom_component:
  - lambda: |-
      auto fingerprint = new FingerprintSensor(id(fingerprint_uart));
      App.register_component(fingerprint);
      return {fingerprint};
    components:
      - id: fingerprint_component

# Services for Home Assistant
# These allow you to call actions from Home Assistant
api:
  services:
    # Enroll a new fingerprint
    - service: enroll_fingerprint
      variables:
        finger_id: int
        finger_name: string
      then:
        - logger.log:
            format: "Starting enrollment for ID %d with name %s"
            args: [ 'finger_id', 'finger_name.c_str()' ]
        - lambda: |-
            // Custom enrollment logic will be handled by the component
            id(sensor_status).publish_state("Enrolling: Place finger on sensor");
            
    # Delete a fingerprint
    - service: delete_fingerprint
      variables:
        finger_id: int
      then:
        - logger.log:
            format: "Deleting fingerprint ID %d"
            args: [ 'finger_id' ]
        - lambda: |-
            // Custom delete logic
            id(sensor_status).publish_state("Deleting fingerprint...");
            
    # Clear all fingerprints
    - service: clear_all_fingerprints
      then:
        - logger.log: "Clearing all fingerprints from sensor"
        - lambda: |-
            id(sensor_status).publish_state("Clearing database...");

# Button entities for quick actions
button:
  - platform: restart
    name: "${friendly_name} Restart"
